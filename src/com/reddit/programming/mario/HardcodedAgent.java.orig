package com.reddit.programming.mario;

import ch.idsia.ai.agents.Agent;
import ch.idsia.ai.agents.RegisterableAgent;
import ch.idsia.mario.engine.sprites.Mario;
import ch.idsia.mario.environments.Environment;
import ch.idsia.mario.engine.GlobalOptions;

//Based on ForwardAgent

public class HardcodedAgent extends RegisterableAgent implements Agent
{
	private boolean[] action;
	private int jumpCounter = 0;
	protected int[] marioPosition = null;
	protected Sensors sensors = new Sensors();
	private ASCIIFrame asciiFrame;
	MarioState ms;
	float pred_x, pred_y;

	public HardcodedAgent()
	{
		super("HardcodedAgent");
		action = new boolean[Environment.numberOfButtons];
		reset();

		asciiFrame = new ASCIIFrame();
	}

	@Override
	public void reset()
	{
		action[Mario.KEY_RIGHT] = true;
		action[Mario.KEY_SPEED] = true;
		// disable enemies for the time being
		GlobalOptions.pauseWorld = true;
	}

	@Override
	public boolean[] getAction(Environment observation)
	{
		sensors.updateReadings(observation);
		marioPosition = sensors.getMarioPosition();
		float[] mpos = observation.getMarioFloatPos();
		if(ms == null) {
			// assume one frame of falling before we get an observation :(
			ms = new MarioState(mpos[0], mpos[1], 0.0f, 3.0f);
		} else {
			System.out.println(String.format("mario x,y=(%5.1f,%5.1f)", mpos[0], mpos[1]));
			if(mpos[0] != pred_x || mpos[1] != pred_y) {
				System.out.println("mismatch; aborting");
				System.exit(1);
			}
		}

		if ((GlobalOptions.FPS != GlobalOptions.InfiniteFPS) && GlobalOptions.GameVeiwerOn)
<<<<<<< Updated upstream:src/com/reddit/programming/mario/HardcodedAgent.java
			asciiFrame.Update(sensors.toString(), GlobalOptions.getMarioComponent());

		asciiFrame.tick();

		if (sensors.levelScene[11][13] != 0 || sensors.levelScene[11][12] != 0 ||  DangerOfGap(sensors.levelScene))
=======
			System.out.println(sensors);
		
		//Chance decisions
//		action[Mario.KEY_SPEED] = sensors.fireballsOnScreen == 0;
//		if (oneIn(10))
//			action[Mario.KEY_SPEED] = !action[Mario.KEY_SPEED];
//		if (oneIn(100))
//			action[Mario.KEY_JUMP] = !action[Mario.KEY_JUMP];
                int _act_token = (action[Mario.KEY_SPEED] ? 1 : 0) |
                  (action[Mario.KEY_RIGHT] ? 2 : 0) |
                  (action[Mario.KEY_JUMP] ? 4 : 0) |
                  (action[Mario.KEY_LEFT] ? 8 : 0);
        //End chance decisions
		
		if (isMarioStuck(sensors.levelScene))// ||  DangerOfGap(sensors.levelScene))
>>>>>>> Stashed changes:src/com/reddit/programming/mario/HardcodedAgent.java
		{
			if (isMarioStuck(sensors.levelScene)) {
				System.out.println("Mario is stuck!");
			}
			else {
				System.out.println("There is a gap!");
			}
			if (observation.mayMarioJump() || ( !observation.isMarioOnGround() && action[Mario.KEY_JUMP]))
			{
				action[Mario.KEY_JUMP] = true;
				++jumpCounter;
			}
			else {
				action[Mario.KEY_JUMP] = false;
			}
		}

		//This statement tries to keep Mario out of IMMEDIATE DANGER.
		else if (dangerousHorizontalEnemies(sensors.enemiesScene) || !isThereGroundBelowMario(sensors.levelScene)) {
			if (!dangerousEnemiesAbove(sensors.enemiesScene)) {
				if (!isThereGroundBelowMario(sensors.levelScene)) {
					action[Mario.KEY_JUMP] = true;
					++jumpCounter;
					System.out.println("Jumping! Avoiding HOLE");
				}
				else {
					action[Mario.KEY_JUMP] = true;
					++jumpCounter;
					System.out.println("Jumping! Avoiding ENEMY");
				}
			}
			else {
				//Something should go here....
			}
		}
		else {
			action[Mario.KEY_JUMP] = false;
			jumpCounter = 0;
		}

		if (jumpCounter > 32)
		{
			jumpCounter = 0;
			action[Mario.KEY_JUMP] = false;
		}
<<<<<<< Updated upstream:src/com/reddit/programming/mario/HardcodedAgent.java

		action[Mario.KEY_SPEED] = sensors.fireballsOnScreen == 0;
		if (oneIn(10))
			action[Mario.KEY_SPEED] = !action[Mario.KEY_SPEED];
		if (oneIn(100))
			action[Mario.KEY_JUMP] = !action[Mario.KEY_JUMP];
		int _act_token = (action[Mario.KEY_SPEED] ? 1 : 0) |
		(action[Mario.KEY_RIGHT] ? 2 : 0) |
		(action[Mario.KEY_JUMP] ? 4 : 0) |
		(action[Mario.KEY_LEFT] ? 8 : 0);
		// quantize mario's position to get the map origin
		int mX = (int)ms.x/16 - 11;
		int mY = (int)ms.y/16 - 11;
		ms = ms.next(_act_token, sensors.levelScene, mX,mY);
		pred_x = ms.x;
		pred_y = ms.y;
		System.out.println(String.format("action: %d; predicted x,y=(%5.1f,%5.1f) xa,ya=(%5.1f,%5.1f)",
				_act_token, ms.x, ms.y, ms.xa, ms.ya));
		return action;
	}

	private boolean isThereGround(byte[][] levelScene) {

		return true;
	}

=======
		
                ms = ms.next(_act_token, sensors.levelScene);
                System.out.println(String.format("action: %d; predicted x,y=(%5.1f,%5.1f) xa,ya=(%5.1f,%5.1f)",
                      _act_token, ms.x, ms.y, ms.xa, ms.ya));
		return action;
	}
	
	private boolean isMarioStuck(byte[][] levelScene) {
		int y = marioPosition[0];
		int x = marioPosition[1];
		if (levelScene[y][x-1] == sensors.EMPTY) {
			return false;
		}
		return true;
	}
	
	private boolean isThereGroundBelowMario(byte[][] levelScene) {
		int y = marioPosition[0];
		int x = marioPosition[1];
		if (levelScene[21][x] == sensors.EMPTY) {
			return false;
		}
		return true;
	}
	
	protected boolean DangerOfGap(byte[][] levelScene)
	{
		int y = marioPosition[0];
		int x = marioPosition[1];
		for (x=x; x < 13; ++x)
		{
			boolean f = true;
			if  (levelScene[21][x] != sensors.EMPTY)
				f = false;
			if (f && levelScene[21][marioPosition[1]] != sensors.EMPTY) {
				System.out.println("Danger of gap! Look out!");
				return true;
			}
		}
		return false;
	}
	
>>>>>>> Stashed changes:src/com/reddit/programming/mario/HardcodedAgent.java
	private boolean dangerousHorizontalEnemies(byte[][] enemiesScene) {
		int y = marioPosition[0];
		int x = marioPosition[1];
		if (sensors.isDangerous(enemiesScene[y][x])
				||sensors.isDangerous(enemiesScene[y][x+1])
				||sensors.isDangerous(enemiesScene[y][x+2]))
			return true;
		return false;
	}
<<<<<<< Updated upstream:src/com/reddit/programming/mario/HardcodedAgent.java

	private boolean dangerousVerticalEnemies(byte[][] enemiesScene) {
		int y = marioPosition[0];
		int x = marioPosition[1];
		if (sensors.isDangerous(enemiesScene[y][x])
				||sensors.isDangerous(enemiesScene[y+1][x])
				||sensors.isDangerous(enemiesScene[y-1][x]))
=======
	
	private boolean dangerousEnemiesAbove(byte[][] enemiesScene) {
		int y = marioPosition[0];
		int x = marioPosition[1];
		if (sensors.isDangerous(enemiesScene[y][x])
		  ||sensors.isDangerous(enemiesScene[y+1][x])
		  ||sensors.isDangerous(enemiesScene[y+2][x])
		  ||sensors.isDangerous(enemiesScene[y+3][x]))
>>>>>>> Stashed changes:src/com/reddit/programming/mario/HardcodedAgent.java
			return true;
		return false;
	}

	private boolean oneIn(int num) {
		return ((int)(Math.random () * num)) == 1;
	}
}
